<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Fighter - Algonova</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0a0a0f;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Press Start 2P', cursive;
            overflow: hidden;
        }

        .game-container {
            width: 900px;
            height: 600px;
            position: relative;
            border: 4px solid #333;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(138, 43, 226, 0.3);
        }

        /* PIXEL ART CITY BACKGROUND */
        .arena-bg {
            position: absolute;
            width: 100%;
            height: 100%;
            background: url('assets/arena-bg.png') center/cover no-repeat;
        }

        /* Stars - hidden with custom background */
        .stars {
            display: none;
            position: absolute;
            width: 100%;
            height: 40%;
            background-image:
                radial-gradient(1px 1px at 100px 50px, white, transparent),
                radial-gradient(1px 1px at 200px 80px, white, transparent),
                radial-gradient(2px 2px at 300px 30px, #fff8, transparent),
                radial-gradient(1px 1px at 400px 60px, white, transparent),
                radial-gradient(1px 1px at 500px 40px, white, transparent),
                radial-gradient(2px 2px at 600px 70px, #fff8, transparent),
                radial-gradient(1px 1px at 700px 20px, white, transparent),
                radial-gradient(1px 1px at 150px 90px, white, transparent),
                radial-gradient(1px 1px at 350px 100px, white, transparent),
                radial-gradient(1px 1px at 550px 85px, white, transparent),
                radial-gradient(1px 1px at 750px 95px, white, transparent),
                radial-gradient(1px 1px at 50px 70px, white, transparent),
                radial-gradient(1px 1px at 850px 55px, white, transparent);
        }

        /* City skyline - back layer - hidden with custom background */
        .city-back {
            display: none;
            position: absolute;
            bottom: 180px;
            width: 100%;
            height: 200px;
        }

        .building-back {
            position: absolute;
            bottom: 0;
            background: #1a1a2e;
        }

        .b1 { left: 0; width: 80px; height: 120px; }
        .b2 { left: 70px; width: 60px; height: 160px; }
        .b3 { left: 120px; width: 100px; height: 140px; }
        .b4 { left: 210px; width: 70px; height: 180px; }
        .b5 { left: 270px; width: 90px; height: 130px; }
        .b6 { left: 350px; width: 80px; height: 170px; }
        .b7 { left: 420px; width: 110px; height: 150px; }
        .b8 { left: 520px; width: 70px; height: 190px; }
        .b9 { left: 580px; width: 90px; height: 140px; }
        .b10 { left: 660px; width: 80px; height: 160px; }
        .b11 { left: 730px; width: 100px; height: 175px; }
        .b12 { left: 820px; width: 80px; height: 145px; }

        /* Windows on back buildings */
        .building-back::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 5px;
            right: 5px;
            bottom: 10px;
            background-image:
                linear-gradient(90deg, #ffeb3b33 2px, transparent 2px),
                linear-gradient(#ffeb3b33 2px, transparent 2px);
            background-size: 12px 15px;
        }

        /* City skyline - front layer - hidden with custom background */
        .city-front {
            display: none;
            position: absolute;
            bottom: 150px;
            width: 100%;
            height: 180px;
        }

        .building-front {
            position: absolute;
            bottom: 0;
            background: #12121f;
        }

        .bf1 { left: -20px; width: 100px; height: 100px; }
        .bf2 { left: 60px; width: 80px; height: 130px; }
        .bf3 { left: 150px; width: 70px; height: 90px; }
        .bf4 { left: 230px; width: 90px; height: 110px; }
        .bf5 { left: 340px; width: 60px; height: 85px; }
        .bf6 { left: 450px; width: 100px; height: 120px; }
        .bf7 { left: 560px; width: 75px; height: 95px; }
        .bf8 { left: 650px; width: 85px; height: 115px; }
        .bf9 { left: 750px; width: 70px; height: 80px; }
        .bf10 { left: 830px; width: 90px; height: 105px; }

        /* Neon ALGONOVA sign - hidden with custom background */
        .neon-sign {
            display: none;
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
            color: #b388ff;
            text-shadow:
                0 0 5px #b388ff,
                0 0 10px #b388ff,
                0 0 20px #b388ff,
                0 0 40px #9c27b0,
                0 0 80px #9c27b0;
            animation: neon-flicker 3s infinite alternate;
            z-index: 5;
            letter-spacing: 4px;
        }

        @keyframes neon-flicker {
            0%, 19%, 21%, 23%, 25%, 54%, 56%, 100% {
                text-shadow:
                    0 0 5px #b388ff,
                    0 0 10px #b388ff,
                    0 0 20px #b388ff,
                    0 0 40px #9c27b0,
                    0 0 80px #9c27b0;
                opacity: 1;
            }
            20%, 24%, 55% {
                text-shadow: none;
                opacity: 0.8;
            }
        }

        /* Building with sign */
        .sign-building {
            position: absolute;
            bottom: 180px;
            left: 50%;
            transform: translateX(-50%);
            width: 180px;
            height: 200px;
            background: linear-gradient(to bottom, #2a2a4a, #1a1a2e);
            z-index: 4;
        }

        .sign-building::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            background-image:
                linear-gradient(90deg, #4fc3f755 3px, transparent 3px),
                linear-gradient(#4fc3f755 3px, transparent 3px);
            background-size: 18px 20px;
        }

        /* Ground/Platform */
        .ground {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 150px;
            background: linear-gradient(to bottom, #1a1a2a 0%, #0f0f15 100%);
        }

        .ground::before {
            content: '';
            position: absolute;
            top: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #333, #555, #333);
        }

        /* Ground tiles */
        .ground-tiles {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 150px;
            background-image:
                linear-gradient(90deg, #ffffff08 1px, transparent 1px),
                linear-gradient(#ffffff08 1px, transparent 1px);
            background-size: 40px 40px;
        }

        /* HEALTH BARS */
        .health-container {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            z-index: 100;
        }

        .player-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .player-info.right {
            align-items: flex-end;
        }

        .player-name {
            font-size: 10px;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
        }

        .health-bar {
            width: 200px;
            height: 20px;
            background: #333;
            border: 3px solid #555;
            border-radius: 2px;
            overflow: hidden;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(to bottom, #4caf50, #2e7d32);
            transition: width 0.3s ease;
        }

        .health-fill.low {
            background: linear-gradient(to bottom, #f44336, #c62828);
        }

        .health-fill.medium {
            background: linear-gradient(to bottom, #ff9800, #f57c00);
        }

        .hearts {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .heart {
            width: 20px;
            height: 20px;
            font-size: 16px;
            filter: drop-shadow(1px 1px 0 #000);
        }

        /* VS text */
        .vs-text {
            position: absolute;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 16px;
            color: #ffeb3b;
            text-shadow: 2px 2px 0 #000, 0 0 10px #ff9800;
            z-index: 100;
        }

        /* GAME TIMER */
        .game-timer {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 15px;
            border-radius: 8px;
            border: 2px solid #9c27b0;
        }

        .game-timer.warning {
            color: #ff9800;
            animation: timer-pulse 0.5s infinite alternate;
        }

        .game-timer.critical {
            color: #f44336;
            animation: timer-pulse 0.3s infinite alternate;
        }

        @keyframes timer-pulse {
            from { transform: translateX(-50%) scale(1); }
            to { transform: translateX(-50%) scale(1.1); }
        }

        /* CHARACTER SPRITES */
        .characters-area {
            position: absolute;
            bottom: 150px;
            width: 100%;
            height: 200px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding: 0 50px;
            z-index: 50;
        }

        .character {
            position: relative;
            width: 120px;
            height: 160px;
            image-rendering: pixelated;
            transition: transform 0.1s;
        }

        .character.attack {
            animation: attack-left 0.3s ease-out;
        }

        .character.right.attack {
            animation: attack-right 0.3s ease-out;
        }

        .character.hurt {
            animation: hurt 0.3s ease-out;
        }

        .character.lose {
            filter: grayscale(30%);
        }

        .character.win {
            animation: winner-bounce 0.5s ease-in-out infinite;
        }

        @keyframes winner-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* LOSE ANIMATIONS per character */
        .character.lose.panda-lose .panda-sprite {
            animation: panda-cry 0.5s ease-in-out infinite;
        }

        .character.lose.satoru-lose .satoru-sprite {
            animation: satoru-kneel 1s ease-out forwards;
        }

        .character.lose.blaze-lose .blaze-sprite {
            animation: blaze-fall 1s ease-out forwards;
        }

        @keyframes panda-cry {
            0%, 100% { transform: translateY(0) rotate(-2deg); }
            50% { transform: translateY(3px) rotate(2deg); }
        }

        @keyframes satoru-kneel {
            0% { transform: translateY(0) scale(1, 1); }
            100% { transform: translateY(40px) scale(1.1, 0.7); }
        }

        @keyframes blaze-fall {
            0% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(20px) rotate(-10deg); }
            100% { transform: translateY(50px) rotate(-15deg) scale(1.1, 0.8); }
        }

        /* FIREWORKS for winner */
        .fireworks {
            position: absolute;
            width: 200px;
            height: 200px;
            pointer-events: none;
            z-index: 55;
        }

        .firework {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: firework-burst 1s ease-out infinite;
        }

        .firework:nth-child(1) { background: #ff0; left: 50%; top: 20%; animation-delay: 0s; }
        .firework:nth-child(2) { background: #f0f; left: 30%; top: 30%; animation-delay: 0.1s; }
        .firework:nth-child(3) { background: #0ff; left: 70%; top: 25%; animation-delay: 0.2s; }
        .firework:nth-child(4) { background: #f00; left: 40%; top: 15%; animation-delay: 0.3s; }
        .firework:nth-child(5) { background: #0f0; left: 60%; top: 35%; animation-delay: 0.4s; }
        .firework:nth-child(6) { background: #ff0; left: 45%; top: 10%; animation-delay: 0.5s; }
        .firework:nth-child(7) { background: #f0f; left: 55%; top: 40%; animation-delay: 0.6s; }
        .firework:nth-child(8) { background: #0ff; left: 35%; top: 20%; animation-delay: 0.7s; }

        @keyframes firework-burst {
            0% { transform: scale(0); opacity: 1; }
            50% { transform: scale(2); opacity: 1; }
            100% { transform: scale(3); opacity: 0; }
        }

        /* Crying tears for panda */
        .tears {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .tear {
            position: absolute;
            width: 6px;
            height: 12px;
            background: #4fc3f7;
            border-radius: 50% 50% 50% 50%;
            animation: tear-fall 0.6s linear infinite;
        }

        .tear.left { left: 30%; top: 35%; animation-delay: 0s; }
        .tear.right { left: 62%; top: 35%; animation-delay: 0.3s; }

        @keyframes tear-fall {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(40px); opacity: 0; }
        }

        @keyframes attack-left {
            0% { transform: translateX(0); }
            50% { transform: translateX(30px); }
            100% { transform: translateX(0); }
        }

        @keyframes attack-right {
            0% { transform: translateX(0); }
            50% { transform: translateX(-30px); }
            100% { transform: translateX(0); }
        }

        @keyframes hurt {
            0%, 100% { transform: translateX(0); filter: brightness(1); }
            25% { transform: translateX(-10px); filter: brightness(2); }
            75% { transform: translateX(10px); filter: brightness(0.5); }
        }

        /* ===== CHARACTER SPRITES WITH CSS ANIMATIONS ===== */
        /* Using static PNGs with transform-based animations */

        .panda-sprite {
            width: 100%;
            height: 100%;
            background: url('assets/Panda.png') center/contain no-repeat;
            animation: char-idle 2s ease-in-out infinite;
        }

        .satoru-sprite {
            width: 100%;
            height: 100%;
            background: url('assets/Satoru.png') center/contain no-repeat;
            animation: char-idle 2s ease-in-out infinite;
            animation-delay: 0.2s;
        }

        .blaze-sprite {
            width: 100%;
            height: 100%;
            background: url('assets/Guru.png') center/contain no-repeat;
            animation: char-idle 2s ease-in-out infinite;
            animation-delay: 0.4s;
        }

        /* Idle - gentle breathing/sway */
        @keyframes char-idle {
            0%, 100% { transform: translateY(0) scaleY(1); }
            50% { transform: translateY(-3px) scaleY(1.01); }
        }

        /* Attack state */
        .character.attack .panda-sprite,
        .character.attack .satoru-sprite,
        .character.attack .blaze-sprite {
            animation: char-attack 0.4s ease-out forwards !important;
        }

        .character.right.attack .panda-sprite,
        .character.right.attack .satoru-sprite,
        .character.right.attack .blaze-sprite {
            animation: char-attack-right 0.4s ease-out forwards !important;
        }

        @keyframes char-attack {
            0% { transform: translateX(0) scale(1); }
            30% { transform: translateX(50px) scale(1.1); }
            100% { transform: translateX(0) scale(1); }
        }

        @keyframes char-attack-right {
            0% { transform: translateX(0) scale(1); }
            30% { transform: translateX(-50px) scale(1.1); }
            100% { transform: translateX(0) scale(1); }
        }

        /* Hurt state - shake and flash red */
        .character.hurt .panda-sprite,
        .character.hurt .satoru-sprite,
        .character.hurt .blaze-sprite {
            animation: char-hurt 0.4s ease-out !important;
            filter: brightness(1.5) sepia(1) hue-rotate(-50deg) saturate(3);
        }

        @keyframes char-hurt {
            0%, 100% { transform: translateX(0); }
            15% { transform: translateX(-12px) rotate(-3deg); }
            30% { transform: translateX(12px) rotate(3deg); }
            45% { transform: translateX(-8px) rotate(-2deg); }
            60% { transform: translateX(8px) rotate(2deg); }
            75% { transform: translateX(-4px); }
            90% { transform: translateX(4px); }
        }

        /* Win animation - happy bounce */
        .character.win .panda-sprite,
        .character.win .satoru-sprite,
        .character.win .blaze-sprite {
            animation: char-win 0.5s ease-in-out infinite !important;
        }

        @keyframes char-win {
            0%, 100% { transform: translateY(0) rotate(0deg) scale(1); }
            25% { transform: translateY(-20px) rotate(-5deg) scale(1.05); }
            50% { transform: translateY(-5px) rotate(0deg) scale(1.02); }
            75% { transform: translateY(-20px) rotate(5deg) scale(1.05); }
        }

        /* Lose animation - fall down sad */
        .character.lose .panda-sprite,
        .character.lose .satoru-sprite,
        .character.lose .blaze-sprite {
            animation: char-lose 0.8s ease-out forwards !important;
        }

        @keyframes char-lose {
            0% { transform: translateY(0) rotate(0deg); filter: none; }
            100% { transform: translateY(30px) rotate(-12deg); filter: grayscale(70%) brightness(0.6); }
        }

        /* Character select preview - same static images, no idle animation */
        .char-preview .panda-sprite,
        .char-preview .satoru-sprite,
        .char-preview .blaze-sprite {
            animation: none;
        }

        /* PROJECTILES */
        .projectile {
            position: absolute;
            z-index: 60;
            pointer-events: none;
        }

        .projectile-panda {
            width: 40px;
            height: 40px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><rect x="4" y="2" width="8" height="4" fill="%23222"/><rect x="2" y="4" width="4" height="4" fill="%23222"/><rect x="10" y="4" width="4" height="4" fill="%23222"/><rect x="2" y="6" width="12" height="8" fill="%23fff"/><rect x="4" y="8" width="3" height="3" fill="%23222"/><rect x="9" y="8" width="3" height="3" fill="%23222"/><rect x="6" y="12" width="4" height="2" fill="%23ffcccc"/></svg>') center/contain no-repeat;
            animation: spin 0.5s linear infinite;
        }

        .projectile-satoru {
            width: 60px;
            height: 30px;
            background: linear-gradient(90deg, transparent, #03a9f4, #fff, #03a9f4, transparent);
            border-radius: 50%;
            box-shadow: 0 0 20px #03a9f4, 0 0 40px #03a9f4;
        }

        .projectile-blaze {
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, #ffeb3b 0%, #ff9800 40%, #f44336 70%, transparent 100%);
            border-radius: 50%;
            box-shadow: 0 0 20px #ff5722, 0 0 40px #ff5722;
            animation: flicker 0.1s infinite alternate;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes flicker {
            from { transform: scale(1); opacity: 1; }
            to { transform: scale(1.1); opacity: 0.8; }
        }

        .projectile.moving-right {
            animation: fly-right 0.4s ease-out forwards;
        }

        .projectile.moving-left {
            animation: fly-left 0.4s ease-out forwards;
        }

        @keyframes fly-right {
            from { left: 150px; opacity: 1; }
            to { left: 650px; opacity: 0; }
        }

        @keyframes fly-left {
            from { right: 150px; opacity: 1; }
            to { right: 650px; opacity: 0; }
        }

        /* EXPLOSION for wrong answer */
        .explosion {
            position: absolute;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, #fff 0%, #ffeb3b 20%, #ff5722 50%, transparent 70%);
            border-radius: 50%;
            animation: explode 0.4s ease-out forwards;
            z-index: 70;
        }

        @keyframes explode {
            0% { transform: scale(0); opacity: 1; }
            50% { transform: scale(1.5); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        /* MATH PROBLEMS AREA */
        .problems-area {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            border: 3px solid #9c27b0;
            border-radius: 8px;
            padding: 15px;
            z-index: 100;
            box-shadow: 0 0 20px rgba(156, 39, 176, 0.5);
        }

        .problem-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
        }

        .problem-text {
            font-size: 14px;
            color: #fff;
            min-width: 150px;
        }

        .problem-input {
            width: 80px;
            height: 30px;
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            text-align: center;
            background: #1a1a2a;
            border: 2px solid #666;
            color: #fff;
            border-radius: 4px;
        }

        .problem-input:focus {
            border-color: #9c27b0;
            outline: none;
            box-shadow: 0 0 10px rgba(156, 39, 176, 0.5);
        }

        .problem-input.correct {
            border-color: #4caf50;
            background: #1b5e20;
        }

        .problem-input.wrong {
            border-color: #f44336;
            background: #b71c1c;
        }

        .submit-btn {
            width: 30px;
            height: 30px;
            font-size: 16px;
            background: #4caf50;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .submit-btn:hover {
            background: #66bb6a;
            transform: scale(1.1);
        }

        .submit-btn:disabled {
            background: #555;
            cursor: not-allowed;
        }

        /* COUNTDOWN */
        .countdown {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            color: #ffeb3b;
            text-shadow: 4px 4px 0 #000, 0 0 30px #ff9800;
            z-index: 200;
            animation: countdown-pop 0.5s ease-out;
        }

        @keyframes countdown-pop {
            0% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* GAME SCREENS */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.9);
            z-index: 300;
        }

        .screen.hidden {
            display: none;
        }

        .title {
            font-size: 32px;
            color: #b388ff;
            text-shadow: 0 0 20px #9c27b0;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 12px;
            color: #fff;
            margin-bottom: 40px;
        }

        .menu-btn {
            font-family: 'Press Start 2P', cursive;
            font-size: 14px;
            padding: 15px 30px;
            margin: 10px;
            background: linear-gradient(to bottom, #9c27b0, #7b1fa2);
            border: 3px solid #ce93d8;
            color: #fff;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .menu-btn:hover {
            background: linear-gradient(to bottom, #ab47bc, #8e24aa);
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(156, 39, 176, 0.5);
        }

        /* CHARACTER SELECT */
        .character-select {
            display: flex;
            gap: 30px;
            margin: 30px 0;
        }

        .char-card {
            width: 220px;
            padding: 25px;
            background: #1a1a2a;
            border: 3px solid #555;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .char-card:hover {
            border-color: #9c27b0;
            transform: translateY(-10px);
            box-shadow: 0 10px 30px rgba(156, 39, 176, 0.3);
        }

        .char-card.selected {
            border-color: #ffeb3b;
            box-shadow: 0 0 30px rgba(255, 235, 59, 0.5);
        }

        .char-preview {
            width: 160px;
            height: 200px;
            margin: 0 auto 15px;
        }

        .char-name {
            font-size: 12px;
            color: #fff;
            margin-top: 10px;
        }

        /* WIN/LOSE SCREEN */
        .result-text {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .result-text.win {
            color: #4caf50;
            text-shadow: 0 0 30px #4caf50;
        }

        .result-text.lose {
            color: #f44336;
            text-shadow: 0 0 30px #f44336;
        }

        .result-stats {
            font-size: 12px;
            color: #fff;
            margin-bottom: 30px;
        }

        /* Pulse animation for waiting */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* INSTRUCTIONS SCREEN */
        .instructions {
            background: rgba(0, 0, 0, 0.95);
            padding: 30px;
            border-radius: 12px;
            border: 3px solid #9c27b0;
            max-width: 500px;
            text-align: left;
        }

        .instructions h2 {
            font-size: 16px;
            color: #b388ff;
            text-align: center;
            margin-bottom: 20px;
        }

        .instruction-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin: 15px 0;
            font-size: 11px;
            color: #fff;
            line-height: 1.6;
        }

        .instruction-icon {
            font-size: 20px;
            min-width: 30px;
            text-align: center;
        }

        .instruction-highlight {
            color: #ffeb3b;
        }

        .instruction-warning {
            color: #ff5252;
        }

        /* Level indicator */
        .level-badge {
            font-size: 8px;
            color: #ffeb3b;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="game-container" id="game">
        <!-- BACKGROUND -->
        <div class="arena-bg">
            <div class="stars"></div>

            <!-- City Back Layer -->
            <div class="city-back">
                <div class="building-back b1"></div>
                <div class="building-back b2"></div>
                <div class="building-back b3"></div>
                <div class="building-back b4"></div>
                <div class="building-back b5"></div>
                <div class="building-back b6"></div>
                <div class="building-back b7"></div>
                <div class="building-back b8"></div>
                <div class="building-back b9"></div>
                <div class="building-back b10"></div>
                <div class="building-back b11"></div>
                <div class="building-back b12"></div>
            </div>

            <!-- Building with Neon Sign -->
            <div class="sign-building"></div>
            <div class="neon-sign">ALGONOVA</div>

            <!-- City Front Layer -->
            <div class="city-front">
                <div class="building-front bf1"></div>
                <div class="building-front bf2"></div>
                <div class="building-front bf3"></div>
                <div class="building-front bf4"></div>
                <div class="building-front bf5"></div>
                <div class="building-front bf6"></div>
                <div class="building-front bf7"></div>
                <div class="building-front bf8"></div>
                <div class="building-front bf9"></div>
                <div class="building-front bf10"></div>
            </div>

            <!-- Ground -->
            <div class="ground">
                <div class="ground-tiles"></div>
            </div>
        </div>

        <!-- HEALTH BARS -->
        <div class="health-container" id="healthContainer" style="display: none;">
            <div class="player-info">
                <div class="player-name" id="player1Name">PLAYER</div>
                <div class="health-bar">
                    <div class="health-fill" id="player1Health" style="width: 100%"></div>
                </div>
                <div class="hearts" id="player1Hearts">
                    <span class="heart">‚ù§Ô∏è</span>
                    <span class="heart">‚ù§Ô∏è</span>
                    <span class="heart">‚ù§Ô∏è</span>
                </div>
            </div>

            <div class="vs-text">VS</div>
            <div class="game-timer" id="gameTimer" style="display: none;">1:00</div>

            <div class="player-info right">
                <div class="player-name" id="player2Name">AI</div>
                <div class="health-bar">
                    <div class="health-fill" id="player2Health" style="width: 100%"></div>
                </div>
                <div class="hearts" id="player2Hearts">
                    <span class="heart">‚ù§Ô∏è</span>
                    <span class="heart">‚ù§Ô∏è</span>
                    <span class="heart">‚ù§Ô∏è</span>
                </div>
            </div>
        </div>

        <!-- CHARACTERS -->
        <div class="characters-area" id="charactersArea" style="display: none;">
            <div class="character" id="player1Char">
                <div class="panda-sprite"></div>
            </div>
            <div class="character right" id="player2Char">
                <div class="satoru-sprite"></div>
            </div>
        </div>

        <!-- PROJECTILES CONTAINER -->
        <div id="projectilesContainer"></div>

        <!-- MATH PROBLEMS -->
        <div class="problems-area" id="problemsArea" style="display: none;">
            <div id="problemsList"></div>
        </div>

        <!-- COUNTDOWN -->
        <div class="countdown hidden" id="countdown"></div>

        <!-- MAIN MENU SCREEN -->
        <div class="screen" id="menuScreen">
            <div class="title">MATH FIGHTER</div>
            <div class="subtitle">by ALGONOVA</div>
            <button class="menu-btn" onclick="showCharacterSelect('solo')">‚öîÔ∏è –ò–ì–†–ê–¢–¨</button>
            <button class="menu-btn" onclick="showCharacterSelect('multi')" style="background: linear-gradient(to bottom, #e91e63, #c2185b); border-color: #f48fb1;">üë• –ò–ì–†–ê–¢–¨ –° –î–†–£–ì–û–ú</button>
            <button class="menu-btn" onclick="showLeaderboard()">üèÜ –õ–ò–î–ï–†–ë–û–†–î</button>
        </div>

        <!-- WAITING ROOM SCREEN -->
        <div class="screen hidden" id="waitingScreen">
            <div class="title" style="font-size: 18px;">‚è≥ –û–ñ–ò–î–ê–ù–ò–ï –ò–ì–†–û–ö–ê</div>
            <div style="margin: 20px 0; padding: 20px; background: #1a1a2a; border-radius: 8px; border: 2px solid #9c27b0;">
                <div style="font-size: 10px; color: #888; margin-bottom: 10px;">–û—Ç–ø—Ä–∞–≤—å —Å—Å—ã–ª–∫—É –¥—Ä—É–≥—É:</div>
                <div id="roomLink" style="font-size: 9px; color: #b388ff; word-break: break-all; margin-bottom: 15px; padding: 10px; background: #0a0a0f; border-radius: 4px;"></div>
                <button class="menu-btn" onclick="copyRoomLink()" style="font-size: 10px; padding: 10px 20px;">üìã –ö–û–ü–ò–†–û–í–ê–¢–¨</button>
            </div>
            <div style="font-size: 10px; color: #888; animation: pulse 2s infinite;">–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...</div>
            <button class="menu-btn" onclick="showMenu()" style="margin-top: 20px; background: #555; border-color: #777;">‚Üê –û–¢–ú–ï–ù–ê</button>
        </div>

        <!-- CHARACTER SELECT SCREEN -->
        <div class="screen hidden" id="charSelectScreen">
            <div class="title" style="font-size: 20px;">–í–´–ë–ï–†–ò –ë–û–ô–¶–ê</div>
            <div class="character-select">
                <div class="char-card" onclick="selectCharacter('panda')" id="card-panda">
                    <div class="char-preview">
                        <div class="panda-sprite"></div>
                    </div>
                    <div class="char-name">–ü–ê–ù–î–ê-–¢–Ø–ù</div>
                    <div class="level-badge">‚≠ê LVL 1</div>
                </div>
                <div class="char-card" onclick="selectCharacter('satoru')" id="card-satoru">
                    <div class="char-preview">
                        <div class="satoru-sprite"></div>
                    </div>
                    <div class="char-name">–°–ê–¢–û–†–£</div>
                    <div class="level-badge">‚≠ê LVL 1</div>
                </div>
                <div class="char-card" onclick="selectCharacter('blaze')" id="card-blaze">
                    <div class="char-preview">
                        <div class="blaze-sprite"></div>
                    </div>
                    <div class="char-name">–°–ï–ù–°–ï–ô</div>
                    <div class="level-badge">‚≠ê LVL 1</div>
                </div>
            </div>
            <button class="menu-btn" onclick="showInstructions()" id="startBtn" disabled>–ù–ê–ß–ê–¢–¨ –ë–û–ô</button>
            <button class="menu-btn" onclick="showMenu()" style="background: #555; border-color: #777;">‚Üê –ù–ê–ó–ê–î</button>
        </div>

        <!-- INSTRUCTIONS SCREEN -->
        <div class="screen hidden" id="instructionsScreen">
            <div class="instructions">
                <h2>‚öîÔ∏è –ö–ê–ö –ò–ì–†–ê–¢–¨</h2>
                <div class="instruction-item">
                    <span class="instruction-icon">üßÆ</span>
                    <span>–†–µ—à–∞–π –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã. –ü–æ—Å–ª–µ –≤–≤–æ–¥–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞–∂–º–∏ <span class="instruction-highlight">–∑–µ–ª—ë–Ω—É—é –≥–∞–ª–æ—á–∫—É ‚úì</span></span>
                </div>
                <div class="instruction-item">
                    <span class="instruction-icon">üéØ</span>
                    <span>–ü–æ–±–µ–∂–¥–∞–µ—Ç —Ç–æ—Ç, –∫—Ç–æ –ø–µ—Ä–≤—ã–º –¥–∞—Å—Ç <span class="instruction-highlight">3 –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–∞</span>. –ú–æ–∂–Ω–æ —Ä–µ—à–∞—Ç—å –ø—Ä–∏–º–µ—Ä—ã –≤ –ª—é–±–æ–º –ø–æ—Ä—è–¥–∫–µ!</span>
                </div>
                <div class="instruction-item">
                    <span class="instruction-icon">üí•</span>
                    <span class="instruction-warning">–ó–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å —É–¥–∞—Ä!</span>
                </div>
                <div class="instruction-item">
                    <span class="instruction-icon">‚è±Ô∏è</span>
                    <span>–£ —Ç–µ–±—è –µ—Å—Ç—å <span class="instruction-highlight">1 –º–∏–Ω—É—Ç–∞</span>. –ï—Å–ª–∏ –≤—Ä–µ–º—è –≤—ã–π–¥–µ—Ç ‚Äî –ø–æ–±–µ–¥–∏—Ç —Ç–æ—Ç, —É –∫–æ–≥–æ –±–æ–ª—å—à–µ HP</span>
                </div>
            </div>
            <button class="menu-btn" onclick="startGame()" style="margin-top: 20px;">‚öîÔ∏è –í –ë–û–ô!</button>
            <button class="menu-btn" onclick="showCharacterSelect()" style="background: #555; border-color: #777;">‚Üê –ù–ê–ó–ê–î</button>
        </div>

        <!-- RESULT SCREEN -->
        <div class="screen hidden" id="resultScreen">
            <div class="result-text" id="resultText">–ü–û–ë–ï–î–ê!</div>
            <div class="result-stats" id="resultStats">–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: 3/5</div>
            <button class="menu-btn" onclick="startGame()">üîÑ –ï–©–Å –†–ê–ó</button>
            <button class="menu-btn" onclick="showCharacterSelect()">üë§ –í–´–ë–†–ê–¢–¨ –ë–û–ô–¶–ê</button>
            <button class="menu-btn" onclick="showMenu()" style="background: #555; border-color: #777;">üè† –ú–ï–ù–Æ</button>
        </div>

        <!-- LEADERBOARD SCREEN -->
        <div class="screen hidden" id="leaderboardScreen">
            <div class="title" style="font-size: 20px;">üèÜ –õ–ò–î–ï–†–ë–û–†–î</div>
            <div id="leaderboardList" style="margin: 20px 0; max-height: 300px; overflow-y: auto;"></div>
            <button class="menu-btn" onclick="showMenu()">‚Üê –ù–ê–ó–ê–î</button>
        </div>
    </div>

    <script>
        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAADPvAgtg5YjGyj6DykBHEZ9O0CqagtyM",
            authDomain: "math-fighter-9c354.firebaseapp.com",
            databaseURL: "https://math-fighter-9c354-default-rtdb.firebaseio.com",
            projectId: "math-fighter-9c354",
            storageBucket: "math-fighter-9c354.firebasestorage.app",
            messagingSenderId: "97829895286",
            appId: "1:97829895286:web:9e5a53b1ef8d4f521f3357"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // GAME STATE
        let gameState = {
            mode: 'solo', // 'solo' or 'multi'
            roomId: null,
            isHost: false,
            roomRef: null,
            playerId: null,
            player1: {
                character: null,
                health: 3,
                level: 1,
                wins: 0,
                correctAnswers: 0
            },
            player2: {
                character: 'satoru',
                health: 3,
                level: 1,
                isAI: true
            },
            problems: [],
            currentProblem: 0,
            gameActive: false,
            difficulty: 'normal',
            timeLeft: 60,
            timerInterval: null
        };

        // CHARACTERS DATA
        const characters = {
            panda: {
                name: '–ü–ê–ù–î–ê-–¢–Ø–ù',
                sprite: 'panda-sprite',
                projectile: 'projectile-panda',
                attack: 'üêº'
            },
            satoru: {
                name: '–°–ê–¢–û–†–£',
                sprite: 'satoru-sprite',
                projectile: 'projectile-satoru',
                attack: '‚ö°'
            },
            blaze: {
                name: '–°–ï–ù–°–ï–ô',
                sprite: 'blaze-sprite',
                projectile: 'projectile-blaze',
                attack: 'üî•'
            }
        };

        // Generate math problems (7th grade level)
        function generateProblems(count = 5) {
            const problems = [];
            const problemTypes = [
                'negative_add',      // –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —á–∏—Å–ª–∞: —Å–ª–æ–∂–µ–Ω–∏–µ
                'negative_mult',     // –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —á–∏—Å–ª–∞: —É–º–Ω–æ–∂–µ–Ω–∏–µ
                'power',             // –°—Ç–µ–ø–µ–Ω–∏
                'equation',          // –ü—Ä–æ—Å—Ç—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è
                'percent',           // –ü—Ä–æ—Ü–µ–Ω—Ç—ã
                'fraction_add',      // –°–ª–æ–∂–µ–Ω–∏–µ –¥—Ä–æ–±–µ–π
                'negative_sub'       // –í—ã—á–∏—Ç–∞–Ω–∏–µ —Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º–∏
            ];

            // Shuffle and pick random types
            const shuffled = problemTypes.sort(() => Math.random() - 0.5);

            for (let i = 0; i < count; i++) {
                const type = shuffled[i % shuffled.length];
                let text, answer;

                switch(type) {
                    case 'negative_add': {
                        // -a + b –∏–ª–∏ a + (-b)
                        const a = Math.floor(Math.random() * 20) + 5;
                        const b = Math.floor(Math.random() * 30) + 10;
                        if (Math.random() > 0.5) {
                            text = `(-${a}) + ${b} =`;
                            answer = -a + b;
                        } else {
                            text = `${b} + (-${a}) =`;
                            answer = b + (-a);
                        }
                        break;
                    }
                    case 'negative_sub': {
                        // a - b –≥–¥–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π
                        const a = Math.floor(Math.random() * 15) + 5;
                        const b = Math.floor(Math.random() * 20) + a + 1;
                        text = `${a} - ${b} =`;
                        answer = a - b;
                        break;
                    }
                    case 'negative_mult': {
                        // (-a) √ó b
                        const a = Math.floor(Math.random() * 8) + 2;
                        const b = Math.floor(Math.random() * 10) + 2;
                        const negative = Math.random() > 0.5;
                        if (negative) {
                            text = `(-${a}) √ó ${b} =`;
                            answer = -a * b;
                        } else {
                            text = `(-${a}) √ó (-${b}) =`;
                            answer = a * b;
                        }
                        break;
                    }
                    case 'power': {
                        // a¬≤ –∏–ª–∏ a¬≥
                        const bases = [2, 3, 4, 5, 6, 7, 8, 9, 10];
                        const base = bases[Math.floor(Math.random() * bases.length)];
                        const exp = Math.random() > 0.5 ? 2 : 3;
                        if (exp === 3 && base > 5) {
                            // –î–ª—è –∫—É–±–∞ –±–µ—Ä—ë–º –º–µ–Ω—å—à–∏–µ —á–∏—Å–ª–∞
                            const smallBase = Math.floor(Math.random() * 4) + 2;
                            text = `${smallBase}¬≥ =`;
                            answer = Math.pow(smallBase, 3);
                        } else {
                            text = exp === 2 ? `${base}¬≤ =` : `${base}¬≥ =`;
                            answer = Math.pow(base, exp);
                        }
                        break;
                    }
                    case 'equation': {
                        // x + a = b –∏–ª–∏ a √ó x = b
                        const x = Math.floor(Math.random() * 15) + 2;
                        const a = Math.floor(Math.random() * 20) + 5;
                        if (Math.random() > 0.5) {
                            const b = x + a;
                            text = `x + ${a} = ${b}, x =`;
                            answer = x;
                        } else {
                            const mult = Math.floor(Math.random() * 8) + 2;
                            const result = x * mult;
                            text = `${mult}x = ${result}, x =`;
                            answer = x;
                        }
                        break;
                    }
                    case 'percent': {
                        // a% –æ—Ç b
                        const percents = [10, 20, 25, 50, 75];
                        const percent = percents[Math.floor(Math.random() * percents.length)];
                        const bases = [40, 60, 80, 100, 120, 200];
                        const base = bases[Math.floor(Math.random() * bases.length)];
                        text = `${percent}% –æ—Ç ${base} =`;
                        answer = (percent / 100) * base;
                        break;
                    }
                    case 'fraction_add': {
                        // –ü—Ä–æ—Å—Ç—ã–µ –¥—Ä–æ–±–∏ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –∑–Ω–∞–º–µ–Ω–∞—Ç–µ–ª–µ–º
                        const denom = [2, 4, 5, 10][Math.floor(Math.random() * 4)];
                        const num1 = Math.floor(Math.random() * (denom - 1)) + 1;
                        const num2 = Math.floor(Math.random() * (denom - num1)) + 1;
                        const resultNum = num1 + num2;
                        if (resultNum === denom) {
                            text = `${num1}/${denom} + ${num2}/${denom} =`;
                            answer = 1;
                        } else {
                            // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –æ—Ç–≤–µ—Ç –≤ –¥–µ—Å—è—Ç–∏—á–Ω–æ–π —Ñ–æ—Ä–º–µ
                            text = `${num1}/${denom} + ${num2}/${denom} =`;
                            answer = resultNum / denom;
                        }
                        break;
                    }
                }

                problems.push({
                    text: text,
                    answer: answer,
                    solved: false,
                    solvedBy: null
                });
            }

            return problems;
        }

        // SCREEN NAVIGATION
        function showMenu() {
            hideAllScreens();
            // Reset multiplayer state
            gameState.roomId = null;
            gameState.isHost = false;
            gameState.mode = 'solo';
            if (gameState.roomRef) {
                gameState.roomRef.off();
                gameState.roomRef = null;
            }
            // Clear URL params
            window.history.replaceState({}, document.title, window.location.pathname);
            document.getElementById('menuScreen').classList.remove('hidden');
        }

        function showInstructions() {
            if (!gameState.player1.character) return;

            if (gameState.mode === 'multi') {
                if (!gameState.roomId) {
                    // No room ID = creating new room (HOST)
                    showWaitingRoom();
                } else {
                    // Has room ID from URL = joining existing room (GUEST)
                    joinRoom();
                }
            } else {
                // Solo mode - show instructions
                hideAllScreens();
                document.getElementById('instructionsScreen').classList.remove('hidden');
            }
        }

        function showCharacterSelect(mode = 'solo') {
            gameState.mode = mode;
            hideAllScreens();
            document.getElementById('charSelectScreen').classList.remove('hidden');

            // Update button text based on mode and role
            const startBtn = document.getElementById('startBtn');
            if (mode === 'multi') {
                if (gameState.roomId) {
                    // Joining existing room
                    startBtn.textContent = 'üë• –í–û–ô–¢–ò –í –ö–û–ú–ù–ê–¢–£';
                } else {
                    // Creating new room
                    startBtn.textContent = 'üë• –°–û–ó–î–ê–¢–¨ –ö–û–ú–ù–ê–¢–£';
                }
            } else {
                startBtn.textContent = '–ù–ê–ß–ê–¢–¨ –ë–û–ô';
            }
        }

        function showWaitingRoom() {
            hideAllScreens();

            // Generate room ID
            gameState.roomId = generateRoomId();
            gameState.isHost = true;
            gameState.playerId = 'player1';

            // Show room link
            const roomLink = `${window.location.origin}${window.location.pathname}?room=${gameState.roomId}`;
            document.getElementById('roomLink').textContent = roomLink;

            document.getElementById('waitingScreen').classList.remove('hidden');

            // Create room in Firebase
            gameState.roomRef = database.ref('rooms/' + gameState.roomId);
            gameState.roomRef.set({
                host: {
                    character: gameState.player1.character,
                    health: 3,
                    ready: true
                },
                guest: null,
                problems: null,
                status: 'waiting',
                createdAt: firebase.database.ServerValue.TIMESTAMP
            });

            // Listen for guest joining
            gameState.roomRef.child('guest').on('value', (snapshot) => {
                const guest = snapshot.val();
                if (guest && guest.ready && gameState.isHost) {
                    // Guest joined! Start the game
                    gameState.player2.character = guest.character;
                    gameState.player2.isAI = false;
                    gameState.mode = 'multi'; // Ensure multi mode

                    // Generate problems and sync
                    gameState.problems = generateProblems(5);
                    gameState.roomRef.child('problems').set(gameState.problems);
                    gameState.roomRef.child('status').set('playing');

                    // Stop listening to prevent duplicate starts
                    gameState.roomRef.child('guest').off();

                    // Start game for host
                    startMultiplayerGame();
                }
            });

            // Clean up room on disconnect
            gameState.roomRef.onDisconnect().remove();
        }

        function generateRoomId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function copyRoomLink() {
            const roomLink = document.getElementById('roomLink').textContent;
            navigator.clipboard.writeText(roomLink).then(() => {
                alert('‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
            }).catch(() => {
                // Fallback
                prompt('–°–∫–æ–ø–∏—Ä—É–π —Å—Å—ã–ª–∫—É:', roomLink);
            });
        }

        // Check if joining a room
        function checkRoomJoin() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('room');

            if (roomId) {
                gameState.roomId = roomId;
                gameState.isHost = false;
                gameState.mode = 'multi';
                gameState.playerId = 'player2';

                // Check if room exists
                database.ref('rooms/' + roomId).once('value', (snapshot) => {
                    if (snapshot.exists() && snapshot.val().status === 'waiting') {
                        alert(`üéÆ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ—à—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ: ${roomId}\n\n–í—ã–±–µ—Ä–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞!`);
                        showCharacterSelect('multi');
                    } else {
                        alert('‚ùå –ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –∏–≥—Ä–∞ —É–∂–µ –Ω–∞—á–∞–ª–∞—Å—å');
                        showMenu();
                    }
                });
            }
        }

        // Join room as guest
        function joinRoom() {
            gameState.roomRef = database.ref('rooms/' + gameState.roomId);
            gameState.player2.isAI = false; // Important: playing with real player!

            // Set guest data
            gameState.roomRef.child('guest').set({
                character: gameState.player1.character,
                health: 3,
                ready: true
            });

            // Listen for game start
            gameState.roomRef.child('status').on('value', (snapshot) => {
                if (snapshot.val() === 'playing') {
                    // Get host character
                    gameState.roomRef.child('host').once('value', (hostSnap) => {
                        const hostData = hostSnap.val();
                        if (hostData) {
                            gameState.player2.character = hostData.character;
                            gameState.player2.isAI = false;
                        }

                        // Get problems
                        gameState.roomRef.child('problems').once('value', (probSnap) => {
                            gameState.problems = probSnap.val();
                            startMultiplayerGame();
                        });
                    });
                }
            });

            // Show waiting message
            hideAllScreens();
            document.getElementById('waitingScreen').classList.remove('hidden');
            document.getElementById('roomLink').textContent = '–û–∂–∏–¥–∞–Ω–∏–µ —Ö–æ—Å—Ç–∞...';
        }

        // Start multiplayer game
        function startMultiplayerGame() {
            hideAllScreens();

            // Ensure multiplayer mode is set
            gameState.mode = 'multi';
            gameState.player2.isAI = false;

            // Reset health
            gameState.player1.health = 3;
            gameState.player2.health = 3;
            gameState.player1.correctAnswers = 0;
            gameState.gameActive = false;

            // Setup UI
            setupMultiplayerUI();

            // Start countdown
            startCountdown();

            // Setup Firebase listeners for real-time sync
            setupMultiplayerListeners();
        }

        function setupMultiplayerUI() {
            const p1Char = characters[gameState.player1.character];
            const p2Char = characters[gameState.player2.character];

            if (gameState.isHost) {
                // Host is on left, guest on right
                document.getElementById('player1Char').innerHTML = `<div class="${p1Char.sprite}"></div>`;
                document.getElementById('player2Char').innerHTML = `<div class="${p2Char.sprite}"></div>`;
                document.getElementById('player1Name').textContent = p1Char.name + ' (–¢–´)';
                document.getElementById('player2Name').textContent = p2Char.name;
            } else {
                // Guest sees themselves on left, host on right
                document.getElementById('player1Char').innerHTML = `<div class="${p1Char.sprite}"></div>`;
                document.getElementById('player2Char').innerHTML = `<div class="${p2Char.sprite}"></div>`;
                document.getElementById('player1Name').textContent = p1Char.name + ' (–¢–´)';
                document.getElementById('player2Name').textContent = p2Char.name;
            }

            updateHealthDisplay();
            renderProblems();

            document.getElementById('healthContainer').style.display = 'flex';
            document.getElementById('charactersArea').style.display = 'flex';
        }

        function setupMultiplayerListeners() {
            const playerPath = gameState.isHost ? 'host' : 'guest';
            const opponentPath = gameState.isHost ? 'guest' : 'host';

            // Listen for opponent's health changes
            gameState.roomRef.child(opponentPath + '/health').on('value', (snapshot) => {
                const health = snapshot.val();
                if (health !== null) {
                    gameState.player2.health = health;
                    updateHealthDisplay();

                    // Check win condition
                    if (health <= 0 && gameState.gameActive) {
                        gameState.gameActive = false;
                        showEndAnimation('player1');
                        setTimeout(() => showResult(true), 2000);
                    }
                }
            });

            // Listen for problems being solved
            gameState.roomRef.child('problems').on('value', (snapshot) => {
                const problems = snapshot.val();
                if (problems) {
                    gameState.problems = problems;
                    renderProblems();
                }
            });
        }

        // Sync answer to Firebase
        function syncAnswer(index, correct) {
            if (gameState.mode !== 'multi') return;

            const playerPath = gameState.isHost ? 'host' : 'guest';

            // Update health
            gameState.roomRef.child(playerPath + '/health').set(gameState.player1.health);

            // Mark problem as solved
            if (correct) {
                gameState.roomRef.child('problems/' + index + '/solved').set(true);
                gameState.roomRef.child('problems/' + index + '/solvedBy').set(gameState.playerId);
            }
        }

        function showLeaderboard() {
            hideAllScreens();
            document.getElementById('leaderboardScreen').classList.remove('hidden');
            renderLeaderboard();
        }

        function showResult(won, reason = 'knockout') {
            hideAllScreens();

            // Clear timer
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
            }
            document.getElementById('gameTimer').style.display = 'none';
            document.getElementById('gameTimer').classList.remove('warning', 'critical');

            const resultScreen = document.getElementById('resultScreen');
            const resultText = document.getElementById('resultText');
            const resultStats = document.getElementById('resultStats');

            if (won) {
                resultText.textContent = '–ü–û–ë–ï–î–ê!';
                resultText.className = 'result-text win';
                gameState.player1.wins++;

                // Check for level up
                if (gameState.player1.wins >= 2 && gameState.player1.level === 1) {
                    gameState.player1.level = 2;
                    resultStats.textContent = `üéâ –ù–û–í–´–ô –£–†–û–í–ï–ù–¨! LVL 2`;
                } else if (gameState.player1.wins >= 5 && gameState.player1.level === 2) {
                    gameState.player1.level = 3;
                    resultStats.textContent = `üéâ –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–´–ô –£–†–û–í–ï–ù–¨! LVL 3`;
                } else {
                    if (reason === 'timer') {
                        resultStats.textContent = `‚è±Ô∏è –í—Ä–µ–º—è –≤—ã—à–ª–æ! HP: ${gameState.player1.health} vs ${gameState.player2.health}`;
                    } else if (reason === 'draw') {
                        resultStats.textContent = `ü§ù –ù–∏—á—å—è –ø–æ HP, –Ω–æ —Ç—ã —Ä–µ—à–∏–ª –±–æ–ª—å—à–µ!`;
                    } else {
                        resultStats.textContent = `–ü–æ–±–µ–¥ –ø–æ–¥—Ä—è–¥: ${gameState.player1.wins}`;
                    }
                }

                saveToLeaderboard();
            } else {
                resultText.textContent = '–ü–û–†–ê–ñ–ï–ù–ò–ï';
                resultText.className = 'result-text lose';
                gameState.player1.wins = 0;

                if (reason === 'timer') {
                    resultStats.textContent = `‚è±Ô∏è –í—Ä–µ–º—è –≤—ã—à–ª–æ! HP: ${gameState.player1.health} vs ${gameState.player2.health}`;
                } else if (reason === 'draw') {
                    resultStats.textContent = `ü§ù –ù–∏—á—å—è! –†–µ—à–∏ –±–æ–ª—å—à–µ –ø—Ä–∏–º–µ—Ä–æ–≤ –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑`;
                } else {
                    resultStats.textContent = '–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑!';
                }
            }

            resultScreen.classList.remove('hidden');
        }

        function hideAllScreens() {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('healthContainer').style.display = 'none';
            document.getElementById('charactersArea').style.display = 'none';
            document.getElementById('problemsArea').style.display = 'none';
        }

        // CHARACTER SELECT
        function selectCharacter(char) {
            gameState.player1.character = char;

            document.querySelectorAll('.char-card').forEach(c => c.classList.remove('selected'));
            document.getElementById(`card-${char}`).classList.add('selected');
            document.getElementById('startBtn').disabled = false;
        }

        // START GAME
        function startGame() {
            if (!gameState.player1.character) return;

            hideAllScreens();

            // Reset game state
            gameState.player1.health = 3;
            gameState.player2.health = 3;
            gameState.player1.correctAnswers = 0;
            gameState.problems = generateProblems(5);
            gameState.gameActive = false;

            // Pick random AI character (different from player)
            const aiChars = Object.keys(characters).filter(c => c !== gameState.player1.character);
            gameState.player2.character = aiChars[Math.floor(Math.random() * aiChars.length)];

            // Setup UI
            setupGameUI();

            // Start countdown
            startCountdown();
        }

        function setupGameUI() {
            const p1Char = characters[gameState.player1.character];
            const p2Char = characters[gameState.player2.character];

            // Set character sprites
            document.getElementById('player1Char').innerHTML = `<div class="${p1Char.sprite}"></div>`;
            document.getElementById('player2Char').innerHTML = `<div class="${p2Char.sprite}"></div>`;

            // Set names
            document.getElementById('player1Name').textContent = p1Char.name;
            document.getElementById('player2Name').textContent = 'AI ' + p2Char.name;

            // Reset health display
            updateHealthDisplay();

            // Generate problems UI
            renderProblems();

            // Show game elements
            document.getElementById('healthContainer').style.display = 'flex';
            document.getElementById('charactersArea').style.display = 'flex';
        }

        function updateHealthDisplay() {
            // Player 1
            const p1Health = document.getElementById('player1Health');
            const p1Hearts = document.getElementById('player1Hearts');
            const healthPercent1 = (gameState.player1.health / 3) * 100;
            p1Health.style.width = healthPercent1 + '%';
            p1Health.className = 'health-fill' + (healthPercent1 <= 33 ? ' low' : healthPercent1 <= 66 ? ' medium' : '');
            p1Hearts.innerHTML = '‚ù§Ô∏è'.repeat(gameState.player1.health) + 'üñ§'.repeat(3 - gameState.player1.health);

            // Player 2
            const p2Health = document.getElementById('player2Health');
            const p2Hearts = document.getElementById('player2Hearts');
            const healthPercent2 = (gameState.player2.health / 3) * 100;
            p2Health.style.width = healthPercent2 + '%';
            p2Health.className = 'health-fill' + (healthPercent2 <= 33 ? ' low' : healthPercent2 <= 66 ? ' medium' : '');
            p2Hearts.innerHTML = '‚ù§Ô∏è'.repeat(gameState.player2.health) + 'üñ§'.repeat(3 - gameState.player2.health);
        }

        function renderProblems() {
            const list = document.getElementById('problemsList');
            list.innerHTML = '';

            gameState.problems.forEach((problem, index) => {
                const row = document.createElement('div');
                row.className = 'problem-row';
                row.innerHTML = `
                    <span class="problem-text">${problem.text}</span>
                    <input type="text" class="problem-input" id="input-${index}"
                           ${problem.solved ? 'disabled' : ''}
                           onkeypress="handleKeyPress(event, ${index})">
                    <button class="submit-btn" onclick="submitAnswer(${index})"
                            ${problem.solved ? 'disabled' : ''}>‚úì</button>
                `;
                list.appendChild(row);
            });
        }

        function startCountdown() {
            const countdown = document.getElementById('countdown');
            let count = 3;

            countdown.classList.remove('hidden');
            countdown.textContent = count;

            const interval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdown.textContent = count;
                    countdown.style.animation = 'none';
                    countdown.offsetHeight; // Trigger reflow
                    countdown.style.animation = 'countdown-pop 0.5s ease-out';
                } else if (count === 0) {
                    countdown.textContent = 'FIGHT!';
                    countdown.style.color = '#f44336';
                } else {
                    countdown.classList.add('hidden');
                    countdown.style.color = '#ffeb3b';
                    clearInterval(interval);

                    // Start the game
                    document.getElementById('problemsArea').style.display = 'block';
                    gameState.gameActive = true;

                    // Focus first input
                    document.getElementById('input-0').focus();

                    // Start AI only in solo mode
                    if (gameState.mode === 'solo') {
                        startAI();
                    }

                    // Start timer
                    startTimer();
                }
            }, 800);
        }

        // GAME TIMER
        function startTimer() {
            const timerEl = document.getElementById('gameTimer');
            timerEl.style.display = 'block';
            gameState.timeLeft = 60;
            updateTimerDisplay();

            gameState.timerInterval = setInterval(() => {
                if (!gameState.gameActive) {
                    clearInterval(gameState.timerInterval);
                    return;
                }

                gameState.timeLeft--;
                updateTimerDisplay();

                // Warning at 15 seconds
                if (gameState.timeLeft <= 15 && gameState.timeLeft > 5) {
                    timerEl.classList.add('warning');
                    timerEl.classList.remove('critical');
                }
                // Critical at 5 seconds
                if (gameState.timeLeft <= 5) {
                    timerEl.classList.remove('warning');
                    timerEl.classList.add('critical');
                }

                // Time's up!
                if (gameState.timeLeft <= 0) {
                    clearInterval(gameState.timerInterval);
                    endGameByTimer();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const timerEl = document.getElementById('gameTimer');
            const minutes = Math.floor(gameState.timeLeft / 60);
            const seconds = gameState.timeLeft % 60;
            timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function endGameByTimer() {
            gameState.gameActive = false;

            // Determine winner by health
            if (gameState.player1.health > gameState.player2.health) {
                // Player wins
                document.getElementById('player2Char').classList.add('lose');
                setTimeout(() => showResult(true, 'timer'), 1000);
            } else if (gameState.player2.health > gameState.player1.health) {
                // AI wins
                document.getElementById('player1Char').classList.add('lose');
                setTimeout(() => showResult(false, 'timer'), 1000);
            } else {
                // Draw - player with more correct answers wins, or it's a tie
                if (gameState.player1.correctAnswers > 0) {
                    setTimeout(() => showResult(true, 'draw'), 1000);
                } else {
                    setTimeout(() => showResult(false, 'draw'), 1000);
                }
            }
        }

        // AI LOGIC
        function startAI() {
            const solveNext = () => {
                if (!gameState.gameActive) return;

                // Find unsolved problem
                const unsolved = gameState.problems.findIndex(p => !p.solved);
                if (unsolved === -1) return;

                // AI delay based on difficulty (2-5 seconds)
                const delay = 2000 + Math.random() * 3000;

                setTimeout(() => {
                    if (!gameState.gameActive) return;
                    if (gameState.problems[unsolved].solved) {
                        solveNext();
                        return;
                    }

                    // AI solves correctly
                    gameState.problems[unsolved].solved = true;
                    gameState.problems[unsolved].solvedBy = 'ai';

                    // AI attacks player
                    fireProjectile('right', gameState.player2.character);
                    gameState.player1.health--;

                    setTimeout(() => {
                        document.getElementById('player1Char').classList.add('hurt');
                        setTimeout(() => {
                            document.getElementById('player1Char').classList.remove('hurt');
                        }, 300);
                    }, 350);

                    updateHealthDisplay();
                    renderProblems();

                    checkGameEnd();

                    if (gameState.gameActive) {
                        solveNext();
                    }
                }, delay);
            };

            solveNext();
        }

        // ANSWER SUBMISSION
        function handleKeyPress(event, index) {
            if (event.key === 'Enter') {
                submitAnswer(index);
            }
        }

        function submitAnswer(index) {
            if (!gameState.gameActive) return;
            if (gameState.problems[index].solved) return;

            const input = document.getElementById(`input-${index}`);
            const userAnswer = parseInt(input.value);
            const correctAnswer = gameState.problems[index].answer;

            if (isNaN(userAnswer)) return;

            if (userAnswer === correctAnswer) {
                // Correct!
                input.classList.add('correct');
                gameState.problems[index].solved = true;
                gameState.problems[index].solvedBy = 'player';
                gameState.player1.correctAnswers++;

                // In multiplayer, opponent takes damage
                if (gameState.mode === 'multi') {
                    // Sync to Firebase - opponent will see their health decrease
                    syncAnswer(index, true);
                } else {
                    // Solo mode - AI takes damage
                    gameState.player2.health--;
                }

                // Attack enemy
                fireProjectile('left', gameState.player1.character);

                setTimeout(() => {
                    document.getElementById('player2Char').classList.add('hurt');
                    setTimeout(() => {
                        document.getElementById('player2Char').classList.remove('hurt');
                    }, 300);
                }, 350);

                // Animate player attack
                document.getElementById('player1Char').classList.add('attack');
                setTimeout(() => {
                    document.getElementById('player1Char').classList.remove('attack');
                }, 300);

            } else {
                // Wrong!
                input.classList.add('wrong');

                // Self damage
                showExplosion('left');
                gameState.player1.health--;

                // Sync to Firebase in multiplayer
                if (gameState.mode === 'multi') {
                    syncAnswer(index, false);
                }

                document.getElementById('player1Char').classList.add('hurt');
                setTimeout(() => {
                    document.getElementById('player1Char').classList.remove('hurt');
                    input.classList.remove('wrong');
                    input.value = '';
                }, 300);
            }

            updateHealthDisplay();
            renderProblems();
            checkGameEnd();

            // Focus next unsolved
            const nextUnsolved = gameState.problems.findIndex((p, i) => i > index && !p.solved);
            if (nextUnsolved !== -1) {
                document.getElementById(`input-${nextUnsolved}`).focus();
            }
        }

        function fireProjectile(direction, character) {
            const container = document.getElementById('projectilesContainer');
            const projectile = document.createElement('div');
            const charData = characters[character];

            projectile.className = `projectile ${charData.projectile} moving-${direction === 'left' ? 'right' : 'left'}`;
            projectile.style.top = '320px';

            if (direction === 'left') {
                projectile.style.left = '150px';
            } else {
                projectile.style.right = '150px';
            }

            container.appendChild(projectile);

            setTimeout(() => {
                projectile.remove();
            }, 500);
        }

        function showExplosion(side) {
            const container = document.getElementById('projectilesContainer');
            const explosion = document.createElement('div');
            explosion.className = 'explosion';
            explosion.style.top = '300px';

            if (side === 'left') {
                explosion.style.left = '100px';
            } else {
                explosion.style.right = '100px';
            }

            container.appendChild(explosion);

            setTimeout(() => {
                explosion.remove();
            }, 400);
        }

        function checkGameEnd() {
            if (gameState.player1.health <= 0) {
                gameState.gameActive = false;
                showEndAnimation('player2'); // AI wins
                setTimeout(() => showResult(false), 10000); // 10 sec animation
            } else if (gameState.player2.health <= 0) {
                gameState.gameActive = false;
                showEndAnimation('player1'); // Player wins
                setTimeout(() => showResult(true), 10000); // 10 sec animation
            }
        }

        function showEndAnimation(winner) {
            const p1Char = document.getElementById('player1Char');
            const p2Char = document.getElementById('player2Char');
            const p1Character = gameState.player1.character;
            const p2Character = gameState.player2.character;

            if (winner === 'player1') {
                // Player 1 wins - show fireworks
                p1Char.classList.add('win');
                addFireworks(p1Char);

                // Player 2 loses - show lose animation
                p2Char.classList.add('lose', `${p2Character}-lose`);
                if (p2Character === 'panda') {
                    addTears(p2Char);
                }
            } else {
                // Player 2 (AI) wins
                p2Char.classList.add('win');
                addFireworks(p2Char);

                // Player 1 loses
                p1Char.classList.add('lose', `${p1Character}-lose`);
                if (p1Character === 'panda') {
                    addTears(p1Char);
                }
            }
        }

        function addFireworks(element) {
            const fireworks = document.createElement('div');
            fireworks.className = 'fireworks';
            fireworks.innerHTML = `
                <div class="firework"></div>
                <div class="firework"></div>
                <div class="firework"></div>
                <div class="firework"></div>
                <div class="firework"></div>
                <div class="firework"></div>
                <div class="firework"></div>
                <div class="firework"></div>
            `;
            element.appendChild(fireworks);
        }

        function addTears(element) {
            const tears = document.createElement('div');
            tears.className = 'tears';
            tears.innerHTML = `
                <div class="tear left"></div>
                <div class="tear right"></div>
            `;
            element.appendChild(tears);
        }

        // LEADERBOARD
        function saveToLeaderboard() {
            const leaderboard = JSON.parse(localStorage.getItem('mathFighterLeaderboard') || '[]');
            const playerName = prompt('–í–≤–µ–¥–∏ —Å–≤–æ—ë –∏–º—è –¥–ª—è –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞:', 'Player') || 'Player';

            leaderboard.push({
                name: playerName,
                wins: gameState.player1.wins,
                character: gameState.player1.character,
                level: gameState.player1.level,
                date: new Date().toLocaleDateString()
            });

            leaderboard.sort((a, b) => b.wins - a.wins);
            localStorage.setItem('mathFighterLeaderboard', JSON.stringify(leaderboard.slice(0, 20)));
        }

        function renderLeaderboard() {
            const leaderboard = JSON.parse(localStorage.getItem('mathFighterLeaderboard') || '[]');
            const list = document.getElementById('leaderboardList');

            if (leaderboard.length === 0) {
                list.innerHTML = '<div style="color: #888; font-size: 10px;">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>';
                return;
            }

            list.innerHTML = leaderboard.map((entry, i) => `
                <div style="display: flex; justify-content: space-between; padding: 8px; margin: 5px 0; background: #1a1a2a; border-radius: 4px; font-size: 10px; color: #fff;">
                    <span>${i + 1}. ${entry.name}</span>
                    <span>${entry.wins} –ø–æ–±–µ–¥ (LVL ${entry.level})</span>
                </div>
            `).join('');
        }

        // Initialize
        checkRoomJoin();
        if (!gameState.roomId) {
            showMenu();
        }
    </script>
</body>
</html>
